{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">

<h3>My Orders</h3>

<table class="table table-bordered bg-white">
<tr>
  <th>Gig</th>
  <th>Amount</th>
  <th>Status</th>
  <th>Requirements</th>
  <th>Deadline</th>
  <th>Actions</th>
</tr>

{% for order in orders %}
<tr>
  <td>{{ order.gig.title }}</td>
  <td>₹ {{ order.amount }}</td>
  <td>{{ order.status }}</td>
  <td>{{ order.requirements }}</td>
  <td>{{ order.deadline }}</td>
  <td>

    {% if order.status == 'PENDING' %}
      <a href="{% url 'pay_order' order.order_id %}" class="btn btn-warning btn-sm">Pay</a>
    {% endif %}

    <a href="{% url 'order_chat' order.order_id %}" class="btn btn-secondary btn-sm">
        Chat
    </a>

    {% if order.status == 'COMPLETED' and not order.review %}
      <a href="{% url 'add_review' order.order_id %}" class="btn btn-success btn-sm">
          Leave Review
      </a>
    {% endif %}

    {% if order.status == 'SUBMITTED' and order.revision_count < order.max_revisions %}
      <a href="{% url 'request_revision' order.order.id %}" class="btn btn-warning btn-sm">
          Request Revision
      </a>
    {% endif %}

    {% if order.delivery_file %}
        <a href="{{ order.delivery_file.url }}">Download Source Code</a>
    {% endif %}

    {% if order.output_image %}
        <img src="{{ order.output_image.url }}" width="300">
    {% endif %}


  </td>
</tr>

<tr>
  <td colspan="6">

    <h6>Delivery History:</h6>

    {% for delivery in order.deliveries.all %}
      <div class="card p-2 mb-2">
        <strong>Version {{ delivery.version }}</strong>
        <p>{{ delivery.message }}</p>
        <a href="{{ delivery.file.url }}" class="btn btn-info btn-sm">Download</a>
        <small class="text-muted float-end">
          {{ delivery.submitted_at }}
        </small>
      </div>
    {% empty %}
      <p>No deliveries yet</p>
    {% endfor %}

  </td>
</tr>

{% empty %}
<tr>
  <td colspan="6">No orders yet</td>
</tr>
{% endfor %}

</table>
{% if order.status == 'OVERDUE' %}
  <span class="text-danger">⚠ Overdue</span>
  <p>Penalty: ₹ {{ order.penalty_amount }}</p>
  <a href="{% url 'extend_deadline' order.order_id %}" class="btn btn-warning btn-sm">
      Extend Deadline
  </a>
{% endif %}


</div>

{% endblock %}
